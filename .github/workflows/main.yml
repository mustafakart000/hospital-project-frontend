name: Deploy Frontend

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout Code
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'
        
    # Debug - İlk Kontrol
    - name: Initial Directory Check
      run: |
        pwd
        ls -la
        
    # Bağımlılıkları Yükle
    - name: Install Dependencies
      run: |
        npm install
        
    # Build Öncesi ESLint Devre Dışı Bırak
    - name: Disable ESLint
      run: |
        echo "DISABLE_ESLINT_PLUGIN=true" >> .env
        
    # Build
    - name: Build Frontend
      run: |
        CI=false npm run build
        
    # Build Sonrası Kontrol
    - name: Check Build Output
      run: |
        echo "Current directory contents:"
        ls -la
        echo "Build directory contents:"
        ls -la dist || echo "dist directory not found"
        
    # Expect Yükleme    
    - name: Install Expect
      run: |
        sudo apt-get update
        sudo apt-get install -y expect
        
    # Transfer İşlemi
    - name: Transfer Frontend Files
      run: |
        pwd
        if [ -d "dist" ] && [ "$(ls -A dist)" ]; then
          echo "Transferring files from dist directory..."
          expect <<'EOF'
          spawn scp -r dist/* root@37.148.209.189:/var/www/html/
          expect {
            "Are you sure you want to continue connecting" { send "yes\r"; exp_continue }
            "password:" { send "${{ secrets.SERVER_PASSWORD }}\r" }
          }
          expect eof
        EOF
        else
          echo "Build directory check failed. Contents of current directory:"
          ls -la
          exit 1
        fi
